@model Ecommerce.Web.Areas.Admin.ViewModels.ProductFormViewModel

@{
    ViewData["Title"] = "Chỉnh sửa sản phẩm";
}

<!-- Content Header -->
<div class="content-header">
    <div class="container-fluid">
        <div class="row mb-2">
            <div class="col-sm-12">
                <h1 class="m-0">
                    <i class="fas fa-box text-primary"></i> Chỉnh sửa sản phẩm
                </h1>
            </div>
        </div>
    </div>
</div>

<!-- Main content -->
<section class="content">
    <div class="container-fluid">
        <div class="row">
            <div class="col-md-8">
                <div class="card card-primary">
                    <div class="card-header">
                        <h3 class="card-title">Thông tin sản phẩm</h3>
                    </div>
                    
                    <form asp-action="Edit" method="post">
                        <input type="hidden" asp-for="Id" />
                        <div class="card-body">
                            <div asp-validation-summary="ModelOnly" class="alert alert-danger"></div>

                            <div class="form-group">
                                <label asp-for="Name" class="required">Tên sản phẩm</label>
                                <input asp-for="Name" class="form-control" placeholder="Ví dụ: Áo thun basic, Quần jean slim...">
                                <span asp-validation-for="Name" class="text-danger"></span>
                            </div>

                            <div class="form-group">
                                <label asp-for="Description">Mô tả</label>
                                <textarea asp-for="Description" class="form-control" rows="3" placeholder="Mô tả chi tiết về sản phẩm"></textarea>
                                <span asp-validation-for="Description" class="text-danger"></span>
                            </div>

                            <div class="form-group">
                                <label asp-for="PrimaryCategoryId" class="required"></label>
                                <select asp-for="PrimaryCategoryId" asp-items="Model.Categories" class="form-control">
                                    <option value="">-- Chọn danh mục --</option>
                                </select>
                                <span asp-validation-for="PrimaryCategoryId" class="text-danger"></span>
                            </div>

                            <div class="form-group">
                                <label asp-for="Price" class="required">Giá (VNĐ)</label>
                                <input asp-for="Price" type="number" class="form-control" placeholder="0">
                                <span asp-validation-for="Price" class="text-danger"></span>
                            </div>

                            <div class="form-group">
                                <label asp-for="OriginalPrice">Giá gốc (VNĐ) - Tùy chọn</label>
                                <input asp-for="OriginalPrice" type="number" class="form-control" placeholder="Để trống nếu không có giảm giá">
                                <span asp-validation-for="OriginalPrice" class="text-danger"></span>
                                <small class="form-text text-muted">Nhập giá gốc để hiển thị % giảm giá. Giá gốc phải lớn hơn giá bán.</small>
                            </div>

                            <div class="form-group">
                                <div class="custom-control custom-checkbox">
                                    <input asp-for="IsFeatured" type="checkbox" class="custom-control-input" id="isFeaturedCheck">
                                    <label class="custom-control-label" for="isFeaturedCheck">
                                        <strong>Sản phẩm nổi bật</strong>
                                        <small class="d-block text-muted">Sản phẩm sẽ được hiển thị ở trang chủ</small>
                                    </label>
                                </div>
                            </div>

                            <div class="form-group">
                                <div class="custom-control custom-checkbox">
                                    <input asp-for="IsActive" type="checkbox" class="custom-control-input" id="isActiveCheck">
                                    <label class="custom-control-label" for="isActiveCheck">
                                        <strong>Hoạt động</strong>
                                        <small class="d-block text-muted">Sản phẩm sẽ hiển thị trên giao diện khách hàng</small>
                                    </label>
                                </div>
                            </div>

                            <h6 class="border-bottom pb-2 mt-4 mb-3">
                                <i class="fas fa-images"></i> Hình ảnh sản phẩm (Tối đa 5)
                            </h6>
                            <div class="mb-3">
                                @for (int i = 0; i < 5; i++)
                                {
                                    <div class="form-group">
                                        <div class="input-group mb-2">
                                            <div class="input-group-prepend">
                                                <span class="input-group-text">@(i + 1)</span>
                                            </div>
                                            <input asp-for="ImageUrls[i]" class="form-control img-url-input" data-preview-id="preview-@i" placeholder="Nhập link ảnh...">
                                        </div>
                                        @if (!string.IsNullOrEmpty(Model.ImageUrls[i]))
                                        {
                                            <div class="ml-5">
                                                <img id="preview-@i" 
                                                     src="@Model.ImageUrls[i]" 
                                                     class="img-thumbnail product-thumbnail" 
                                                     style="height: 80px; object-fit: cover; cursor: pointer;" 
                                                     data-image="@Model.ImageUrls[i]"
                                                     data-product="@Model.Name"
                                                     title="Click để xem lớn"
                                                     onerror="this.style.display='none'">
                                            </div>
                                        }
                                    </div>
                                }
                                <span asp-validation-for="ImageUrls" class="text-danger"></span>
                                <small class="form-text text-muted">Nhập URL trực tiếp của ảnh. Ảnh đầu tiên sẽ là ảnh đại diện.</small>
                            </div>
                            
                        </div>

                        <div class="card-footer">
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-save"></i> Lưu thay đổi
                            </button>
                            <a asp-action="Index" class="btn btn-default">
                                <i class="fas fa-times"></i> Hủy
                            </a>
                        </div>
                    </form>
                    
                    @* Product Variants Section - OUTSIDE form to avoid nesting *@
                    @await Html.PartialAsync("_VariantsSection", Model.Id)
                </div>
            </div>

            <div class="col-md-4">
                <div class="card card-info">
                    <div class="card-header">
                        <h3 class="card-title">Thông tin</h3>
                    </div>
                    <div class="card-body">
                        <h6><i class="fas fa-info-circle"></i> Cập nhật sản phẩm</h6>
                        <p class="text-sm">Cập nhật thông tin để giữ sản phẩm luôn chính xác.</p>
                        
                        <h6><i class="fas fa-lightbulb"></i> Lưu ý</h6>
                        <ul class="text-sm pl-3">
                            <li>Kiểm tra lại giá và thông tin trước khi lưu</li>
                            <li>Hình ảnh nên rõ ràng, chất lượng cao</li>
                            <li>Preview ảnh để đảm bảo link đúng</li>
                        </ul>

                        <h6><i class="fas fa-exclamation-triangle text-warning"></i> Quan trọng</h6>
                        <p class="text-sm">Thay đổi giá hoặc danh mục có thể ảnh hưởng đến đơn hàng đang xử lý.</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>

<!-- Image Preview Modal -->
<div class="modal fade" id="imagePreviewModal" tabindex="-1" role="dialog" aria-labelledby="imagePreviewModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="imagePreviewModalLabel">Xem ảnh</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body text-center">
                <img id="previewImage" src="" alt="" class="img-fluid" style="max-height: 500px;">
            </div>
        </div>
    </div>
</div>

@section Scripts {
    @{await Html.RenderPartialAsync("_ValidationScriptsPartial");}
    <script>
        // Simple preview script
        document.querySelectorAll('.img-url-input').forEach(input => {
            input.addEventListener('change', function() {
                const previewId = this.dataset.previewId;
                let img = document.getElementById(previewId);
                if (!img) {
                    // Create img if not exists
                    const wrapper = document.createElement('div');
                    wrapper.className = 'ml-5';
                    img = document.createElement('img');
                    img.id = previewId;
                    img.className = 'img-thumbnail product-thumbnail';
                    img.style.height = '80px';
                    img.style.objectFit = 'cover';
                    img.style.cursor = 'pointer';
                    img.setAttribute('title', 'Click để xem lớn');
                    wrapper.appendChild(img);
                    this.closest('.form-group').appendChild(wrapper);
                    
                    // Add click event for new image
                    img.addEventListener('click', function() {
                        $('#previewImage').attr('src', this.getAttribute('data-image'));
                        $('#previewImage').attr('alt', this.getAttribute('data-product'));
                        $('#imagePreviewModalLabel').text(this.getAttribute('data-product'));
                        $('#imagePreviewModal').modal('show');
                    });
                }
                
                if (this.value) {
                    img.src = this.value;
                    img.setAttribute('data-image', this.value);
                    img.setAttribute('data-product', '@Model.Name');
                    img.style.display = 'block';
                    img.onerror = function() { this.style.display = 'none'; };
                } else {
                    img.style.display = 'none';
                }
            });
        });
        
        // Handle existing thumbnail clicks
        $(document).ready(function() {
            $('.product-thumbnail').on('click', function() {
                var imageUrl = $(this).data('image') || $(this).attr('src');
                var productName = $(this).data('product');
                
                $('#previewImage').attr('src', imageUrl);
                $('#previewImage').attr('alt', productName);
                $('#imagePreviewModalLabel').text(productName);
                
                $('#imagePreviewModal').modal('show');
            });
        });
    </script>
}
