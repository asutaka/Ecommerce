@model Ecommerce.Web.ViewModels.HomeViewModel
@using Ecommerce.Web.Helpers
@{
    ViewData["Title"] = "Moderno Boutique";
    var status = ViewBag.CheckoutStatus as string;
    var heroProduct = Model.FeaturedProducts.FirstOrDefault();
    var newArrivals = Model.NewArrivals?.Any() == true ? Model.NewArrivals : Model.FeaturedProducts.Take(4).ToList();
    var bestSellers = Model.FeaturedProducts.Where(p => p.IsFeatured).Take(4).ToList();
    var slides = new[]
    {
        new {
            Title = "Perfect Match, Trendy Collection",
            Subtitle = "Autumn-Winter 2025",
            Copy = "Thoughtfully designed sets & separates cho tủ đồ hiện đại.",
            CtaPrimary = "#new-in",
            CtaSecondary = "#catalog",
            Badge = "New Season",
            Image = heroProduct?.HeroImageUrl ?? "https://images.unsplash.com/photo-1521572267360-ee0c2909d518?auto=format&fit=crop&w=1400&q=80"
        },
        new {
            Title = "Own Your Style",
            Subtitle = "Bold looks for fearless women",
            Copy = "Những thiết kế nổi bật, tôn dáng và hiện đại – đúng tinh thần Moderno Fashion.",
            CtaPrimary = "#catalog",
            CtaSecondary = "#collections",
            Badge = "Statement Looks",
            Image = "https://images.unsplash.com/photo-1509631179647-0177331693ae?auto=format&fit=crop&w=1400&q=80"
        },
        new {
            Title = "Weekly Fresh Drops",
            Subtitle = "Him · Her · Kids · Accessories",
            Copy = "Hàng mới mỗi tuần, đủ size XS-4XL, giá trực tiếp từ nhà máy.",
            CtaPrimary = "#categories",
            CtaSecondary = "#catalog",
            Badge = "New In Weekly",
            Image = "https://images.unsplash.com/photo-1524504388940-b1c1722653e1?auto=format&fit=crop&w=1400&q=80"
        }
    };
}

@* Database-driven Hero Banner *@
@await Html.PartialAsync("_HeroBannerPartial")

@* Status message *@
@if (!string.IsNullOrWhiteSpace(status))
{
    <div class="alert @(status == "success" ? "alert-success" : "alert-danger")">
        @(status == "success" ? "Đơn hàng đã được gửi vào saga MassTransit." : "Vui lòng kiểm tra thông tin và thử lại.")
    </div>
}

@if (Model.FeaturedCategories.Any())
{
    <section id="categories" class="section" style="max-width: none; width: 100%; margin-top: 16px; margin-bottom: 16px;">
        <div class="section-header">
            <div>
                <p class="pill">Product Categories</p>
                <h3>Khám phá danh mục Moderno</h3>
                <p class="muted">Tees, shirts, dresses, jeans và toàn bộ essentials bạn cần.</p>
            </div>
        </div>
        <div class="category-grid">
            @foreach (var category in Model.FeaturedCategories)
            {
                <div class="category-card-wrapper">
                    <a asp-controller="Category" asp-action="Index" asp-route-id="@category.Id" class="category-card">
                        <div class="category-icon">
                            <i class="bi bi-basket2-fill"></i>
                        </div>
                        <div class="category-name">@category.Name</div>
                    </a>
                    <a asp-controller="Category" asp-action="Index" asp-route-id="@category.Id" class="view-all-btn" style="display: flex; align-items: center; justify-content: center; gap: 4px; padding: 6px 12px; background: transparent; border: 1px solid #e5e7eb; border-radius: 4px; color: inherit; text-decoration: none; font-size: 0.75rem; font-weight: 500; transition: all 0.2s ease;">
                        Xem tất cả <i class="bi bi-arrow-right"></i>
                    </a>
                </div>
            }
        </div>
    </section>
}

@* Promotional Banners *@
@await Html.PartialAsync("_PromotionalBannerPartial")

@if (Model.NewArrivalsByCategory.Any())
{
    <section id="new-in" class="section" style="margin-top: 16px; max-width: 1200px; margin-left: auto; margin-right: auto; padding: 0 20px;">
        @foreach (var category in Model.NewArrivalsByCategory)
        {
            <div class="category-section mb-5">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <a asp-controller="Category" asp-action="Index" asp-route-search="@category.Key" style="text-decoration: none; color: inherit;">
                        <h4 class="mb-0" style="cursor: pointer; transition: color 0.2s ease;" onmouseover="this.style.color='#f59e0b'" onmouseout="this.style.color='inherit'">@category.Key</h4>
                    </a>
                    <a asp-controller="Category" asp-action="Index" asp-route-search="@category.Key" class="btn btn-sm" style="color: #2563eb; border: 1px solid #2563eb; padding: 4px 12px; border-radius: 4px; text-decoration: none; font-size: 0.85rem; transition: all 0.2s ease;" onmouseover="this.style.background='#2563eb'; this.style.color='#fff';" onmouseout="this.style.background='transparent'; this.style.color='#2563eb';">
                        Xem tất cả <i class="bi bi-arrow-right"></i>
                    </a>
                </div>

                <div class="product-slider-wrapper position-relative" style="width: 100%; margin: 0; padding: 0;">
                     <button class="slider-arrow prev" onclick="scrollSlider(this, -1)"><i class="bi bi-chevron-left"></i></button>
                     <button class="slider-arrow next" onclick="scrollSlider(this, 1)"><i class="bi bi-chevron-right"></i></button>

                    <div class="product-slider">
                        @foreach (var product in category.Value)
                        {
                            var productImages = product.Images.Take(3).ToList();
                            var imageCount = productImages.Count;
                             <article class="product-card @(product.IsFeatured ? "featured" : string.Empty)">
                                <a asp-controller="Product" asp-action="Details" asp-route-slug="@product.Slug" class="product-link">
                                    <div class="badge-pill">New</div>
                                    
                                    @* Image Carousel *@
                                    <div class="product-image-carousel" data-product-id="@product.Id">
                                        @for (int i = 0; i < imageCount; i++)
                                        {
                                            <img src="@ImageHelper.OptimizeImageUrl(productImages[i], 800)" 
                                                 srcset="@ImageHelper.GenerateSrcSet(productImages[i])"
                                                 sizes="@ImageHelper.GetDefaultSizes()"
                                                 alt="@product.Name" 
                                                 loading="lazy" 
                                                 class="carousel-image @(i == 0 ? "active" : "")" 
                                                 data-index="@i" />
                                        }
                                        
                                        @* Dots Navigation *@
                                        @if (imageCount > 1)
                                        {
                                            <div class="carousel-dots" onclick="event.preventDefault(); event.stopPropagation();">
                                                @for (int i = 0; i < imageCount; i++)
                                                {
                                                    <span class="dot @(i == 0 ? "active" : "")" 
                                                          onclick="changeProductImage('@product.Id', @i)"></span>
                                                }
                                            </div>
                                        }
                                    </div>
                                    
                                    <div class="card-body">
                                        <div class="card-meta">
                                            <p class="eyebrow">@category.Key</p>
                                            <h3>@product.Name</h3>
                                            <div class="price">@product.Price.ToString("C0", new System.Globalization.CultureInfo("vi-VN"))</div>
                                        </div>
                                    </div>
                                </a>
                            </article>
                        }

                    </div>
                </div>
            </div>
        }
    </section>

    <script>
        function scrollSlider(btn, direction) {
            // Find the slider within the same wrapper as the button
            const wrapper = btn.closest('.product-slider-wrapper');
            if(wrapper) {
                const slider = wrapper.querySelector('.product-slider');
                const scrollAmount = 300;
                slider.scrollBy({ left: direction * scrollAmount, behavior: 'smooth' });
            }
        }
        
        // Change product image in carousel
        function changeProductImage(productId, imageIndex) {
            const carousel = document.querySelector(`[data-product-id="${productId}"]`);
            if (!carousel) return;
            
            // Update images
            const images = carousel.querySelectorAll('.carousel-image');
            images.forEach((img, index) => {
                img.classList.toggle('active', index === imageIndex);
            });
            
            // Update dots
            const dots = carousel.querySelectorAll('.dot');
            dots.forEach((dot, index) => {
                dot.classList.toggle('active', index === imageIndex);
            });
        }
        
        // Lazy load carousel background images
        document.addEventListener('DOMContentLoaded', function() {
            const heroCarousel = document.getElementById('heroCarousel');
            if (!heroCarousel) return;
            
            // Function to load background image
            function loadSlideBackground(slide) {
                const slideInner = slide.querySelector('.hero-slide-inner[data-bg]');
                if (slideInner && slideInner.dataset.bg) {
                    const bgUrl = slideInner.dataset.bg;
                    slideInner.style.backgroundImage = `url('${bgUrl}')`;
                    delete slideInner.dataset.bg; // Remove data-bg after loading
                }
            }
            
            // Load next slide when carousel slides
            heroCarousel.addEventListener('slide.bs.carousel', function(e) {
                loadSlideBackground(e.relatedTarget);
            });
            
            // Preload next slide on page load for smoother transition
            const nextSlide = heroCarousel.querySelector('.carousel-item:not(.active)');
            if (nextSlide) {
                setTimeout(() => loadSlideBackground(nextSlide), 1000);
            }
        });
    </script>
}

@section Scripts {
    <partial name="_ValidationScriptsPartial" />
}
