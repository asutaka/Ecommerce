@model Ecommerce.Web.ViewModels.HomeViewModel
@{
    ViewData["Title"] = "Moderno Boutique";
    var status = ViewBag.CheckoutStatus as string;
    var heroProduct = Model.FeaturedProducts.FirstOrDefault();
    var newArrivals = Model.NewArrivals?.Any() == true ? Model.NewArrivals : Model.FeaturedProducts.Take(4).ToList();
    var bestSellers = Model.FeaturedProducts.Where(p => p.IsFeatured).Take(4).ToList();
    var slides = new[]
    {
        new {
            Title = "Perfect Match, Trendy Collection",
            Subtitle = "Autumn-Winter 2025",
            Copy = "Thoughtfully designed sets & separates cho tủ đồ hiện đại.",
            CtaPrimary = "#new-in",
            CtaSecondary = "#catalog",
            Badge = "New Season",
            Image = heroProduct?.HeroImageUrl ?? "https://images.unsplash.com/photo-1521572267360-ee0c2909d518?auto=format&fit=crop&w=1400&q=80"
        },
        new {
            Title = "Own Your Style",
            Subtitle = "Bold looks for fearless women",
            Copy = "Những thiết kế nổi bật, tôn dáng và hiện đại – đúng tinh thần Moderno Fashion.",
            CtaPrimary = "#catalog",
            CtaSecondary = "#collections",
            Badge = "Statement Looks",
            Image = "https://images.unsplash.com/photo-1509631179647-0177331693ae?auto=format&fit=crop&w=1400&q=80"
        },
        new {
            Title = "Weekly Fresh Drops",
            Subtitle = "Him · Her · Kids · Accessories",
            Copy = "Hàng mới mỗi tuần, đủ size XS-4XL, giá trực tiếp từ nhà máy.",
            CtaPrimary = "#categories",
            CtaSecondary = "#catalog",
            Badge = "New In Weekly",
            Image = "https://images.unsplash.com/photo-1524504388940-b1c1722653e1?auto=format&fit=crop&w=1400&q=80"
        }
    };
}

<section class="hero-carousel-wrapper" style="margin-bottom: 0 !important; max-width: 1200px; margin-left: auto; margin-right: auto; padding: 0 20px;">
    <div id="heroCarousel" class="carousel slide" data-bs-ride="carousel" data-bs-interval="6000">
        <div class="carousel-indicators">
            @for (var i = 0; i < slides.Length; i++)
            {
                <button type="button" data-bs-target="#heroCarousel" data-bs-slide-to="@i" class="@(i == 0 ? "active" : "")" aria-label="Slide @(i + 1)"></button>
            }
        </div>
        <div class="carousel-inner">
            @for (var i = 0; i < slides.Length; i++)
            {
                var slide = slides[i];
                <div class="carousel-item @(i == 0 ? "active" : "")">
                    <div class="hero-slide" style="min-height: 320px !important;">
                        <div class="hero-slide-inner" style="background-image:url('@slide.Image'); min-height: 320px !important;">
                            <div class="hero-overlay">
                                <div class="pill pill-dark">@slide.Badge</div>
                                <p class="pill subtle-pill">@slide.Subtitle</p>
                                <h1>@slide.Title</h1>
                                <p class="lede">@slide.Copy</p>
                                <div class="hero-cta">
                                    <a class="btn btn-primary" href="@slide.CtaPrimary">Shop Now</a>
                                    <a class="btn btn-ghost" href="@slide.CtaSecondary">Xem tất cả</a>
                                </div>
                                <div class="hero-perks">
                                    <span>Miễn phí giao hàng &gt; 1.000.000đ</span>
                                    <span>Đổi trả 30 ngày</span>
                                    <span>Hàng mới mỗi tuần</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            }
        </div>
        <button class="carousel-control-prev" type="button" data-bs-target="#heroCarousel" data-bs-slide="prev">
            <span class="carousel-control-prev-icon" aria-hidden="true"></span>
            <span class="visually-hidden">Previous</span>
        </button>
        <button class="carousel-control-next" type="button" data-bs-target="#heroCarousel" data-bs-slide="next">
            <span class="carousel-control-next-icon" aria-hidden="true"></span>
            <span class="visually-hidden">Next</span>
        </button>
    </div>
</section>

@if (!string.IsNullOrWhiteSpace(status))
{
    <div class="alert @(status == "success" ? "alert-success" : "alert-danger")">
        @(status == "success" ? "Đơn hàng đã được gửi vào saga MassTransit." : "Vui lòng kiểm tra thông tin và thử lại.")
    </div>
}

@if (Model.FeaturedCategories.Any())
{
    <section id="categories" class="section" style="max-width: none; width: 100%; margin-top: 16px; margin-bottom: 16px;">
        <div class="section-header">
            <div>
                <p class="pill">Product Categories</p>
                <h3>Khám phá danh mục Moderno</h3>
                <p class="muted">Tees, shirts, dresses, jeans và toàn bộ essentials bạn cần.</p>
            </div>
        </div>
        <div class="category-grid">
            @foreach (var category in Model.FeaturedCategories)
            {
                <div class="category-card-wrapper">
                    <a asp-controller="Category" asp-action="Index" asp-route-id="@category.Id" class="category-card">
                        <div class="category-icon">
                            <i class="bi bi-basket2-fill"></i>
                        </div>
                        <div class="category-name">@category.Name</div>
                    </a>
                    <a asp-controller="Category" asp-action="Index" asp-route-id="@category.Id" class="view-all-btn" style="display: flex; align-items: center; justify-content: center; gap: 4px; padding: 6px 12px; background: transparent; border: 1px solid #e5e7eb; border-radius: 4px; color: inherit; text-decoration: none; font-size: 0.75rem; font-weight: 500; transition: all 0.2s ease;">
                        Xem tất cả <i class="bi bi-arrow-right"></i>
                    </a>
                </div>
            }
        </div>
    </section>
}

@if (Model.NewArrivalsByCategory.Any())
{
    <section id="new-in" class="section" style="margin-top: 16px; max-width: 1200px; margin-left: auto; margin-right: auto; padding: 0 20px;">
        @foreach (var category in Model.NewArrivalsByCategory)
        {
            <div class="category-section mb-5">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <a asp-controller="Category" asp-action="Index" asp-route-search="@category.Key" style="text-decoration: none; color: inherit;">
                        <h4 class="mb-0" style="cursor: pointer; transition: color 0.2s ease;" onmouseover="this.style.color='#f59e0b'" onmouseout="this.style.color='inherit'">@category.Key</h4>
                    </a>
                    <a asp-controller="Category" asp-action="Index" asp-route-search="@category.Key" class="btn btn-sm" style="color: #2563eb; border: 1px solid #2563eb; padding: 4px 12px; border-radius: 4px; text-decoration: none; font-size: 0.85rem; transition: all 0.2s ease;" onmouseover="this.style.background='#2563eb'; this.style.color='#fff';" onmouseout="this.style.background='transparent'; this.style.color='#2563eb';">
                        Xem tất cả <i class="bi bi-arrow-right"></i>
                    </a>
                </div>

                <div class="product-slider-wrapper position-relative" style="width: 100%; margin: 0; padding: 0;">
                     <button class="slider-arrow prev" onclick="scrollSlider(this, -1)"><i class="bi bi-chevron-left"></i></button>
                     <button class="slider-arrow next" onclick="scrollSlider(this, 1)"><i class="bi bi-chevron-right"></i></button>

                    <div class="product-slider">
                        @foreach (var product in category.Value)
                        {
                            var productImages = product.Images.Take(3).ToList();
                            var imageCount = productImages.Count;
                             <article class="product-card @(product.IsFeatured ? "featured" : string.Empty)">
                                <a asp-controller="Product" asp-action="Details" asp-route-id="@product.Id" class="product-link">
                                    <div class="badge-pill">New</div>
                                    
                                    @* Image Carousel *@
                                    <div class="product-image-carousel" data-product-id="@product.Id">
                                        @for (int i = 0; i < imageCount; i++)
                                        {
                                            <img src="@productImages[i]" 
                                                 alt="@product.Name" 
                                                 loading="lazy" 
                                                 class="carousel-image @(i == 0 ? "active" : "")" 
                                                 data-index="@i" />
                                        }
                                        
                                        @* Dots Navigation *@
                                        @if (imageCount > 1)
                                        {
                                            <div class="carousel-dots" onclick="event.preventDefault(); event.stopPropagation();">
                                                @for (int i = 0; i < imageCount; i++)
                                                {
                                                    <span class="dot @(i == 0 ? "active" : "")" 
                                                          onclick="changeProductImage('@product.Id', @i)"></span>
                                                }
                                            </div>
                                        }
                                    </div>
                                    
                                    <div class="card-body">
                                        <div class="card-meta">
                                            <p class="eyebrow">@category.Key</p>
                                            <h3>@product.Name</h3>
                                            <div class="price">@product.Price.ToString("C0", new System.Globalization.CultureInfo("vi-VN"))</div>
                                        </div>
                                    </div>
                                </a>
                            </article>
                        }

                    </div>
                </div>
            </div>
        }
    </section>

    <script>
        function scrollSlider(btn, direction) {
            // Find the slider within the same wrapper as the button
            const wrapper = btn.closest('.product-slider-wrapper');
            if(wrapper) {
                const slider = wrapper.querySelector('.product-slider');
                const scrollAmount = 300;
                slider.scrollBy({ left: direction * scrollAmount, behavior: 'smooth' });
            }
        }
        
        // Change product image in carousel
        function changeProductImage(productId, imageIndex) {
            const carousel = document.querySelector(`[data-product-id="${productId}"]`);
            if (!carousel) return;
            
            // Update images
            const images = carousel.querySelectorAll('.carousel-image');
            images.forEach((img, index) => {
                img.classList.toggle('active', index === imageIndex);
            });
            
            // Update dots
            const dots = carousel.querySelectorAll('.dot');
            dots.forEach((dot, index) => {
                dot.classList.toggle('active', index === imageIndex);
            });
        }
    </script>
}

<section id="catalog" class="section">
    <div class="catalog-grid">
        @foreach (var product in Model.FeaturedProducts)
        {
            <article class="product-card @(product.IsFeatured ? "featured" : string.Empty)">
                <a asp-controller="Product" asp-action="Details" asp-route-id="@product.Id" class="product-link">
                    @if (product.IsFeatured)
                    {
                        <div class="badge-pill accent">Best Seller</div>
                    }
                    <img src="@product.HeroImageUrl" alt="@product.Name" loading="lazy" />
                    <div class="card-body">
                        <p class="eyebrow">Sản phẩm</p>
                        <h3>@product.Name</h3>
                        <p>@product.Description</p>
                        <div class="card-footer">
                            <span>@product.Price.ToString("C0", new System.Globalization.CultureInfo("vi-VN"))</span>
                            <div class="add-to-cart-group">
                                <input type="number" id="qty-@product.Id" value="1" min="1" max="10" class="qty-input" onclick="event.stopPropagation();" />
                                <button class="btn-add-cart" onclick="event.preventDefault(); event.stopPropagation(); addToCart('@product.Id', document.getElementById('qty-@product.Id').value)">
                                    Thêm vào giỏ
                                </button>
                            </div>
                        </div>
                    </div>
                </a>
            </article>
        }
    </div>
</section>

<section class="checkout-panel" id="checkout">
    <div class="checkout-copy">
        <p class="pill">Đặt hàng nhanh</p>
        <h2>Tạo hóa đơn & kích hoạt Saga thanh toán</h2>
        <p>Form này publish message <code>CreateInvoice</code> lên RabbitMQ để khởi chạy chuỗi Saga (invoice → payment → notify).</p>
        <div class="pill pill-dark">MassTransit · RabbitMQ demo</div>
    </div>
    <form asp-controller="Orders" asp-action="Checkout" method="post" class="checkout-form">
        @Html.AntiForgeryToken()
        <div class="form-group">
            <label asp-for="Checkout.CustomerName"></label>
            <input asp-for="Checkout.CustomerName" placeholder="Họ và tên" />
            <span asp-validation-for="Checkout.CustomerName"></span>
        </div>
        <div class="form-group">
            <label asp-for="Checkout.CustomerEmail"></label>
            <input asp-for="Checkout.CustomerEmail" placeholder="you@example.com" />
            <span asp-validation-for="Checkout.CustomerEmail"></span>
        </div>
        <div class="form-group">
            <label asp-for="Checkout.ProductId">Chọn sản phẩm</label>
            <select asp-for="Checkout.ProductId" asp-items="@(new SelectList(Model.FeaturedProducts, nameof(ProductViewModel.Id), nameof(ProductViewModel.Name)))"></select>
        </div>
        <div class="form-group">
            <label asp-for="Checkout.Quantity"></label>
            <input asp-for="Checkout.Quantity" type="number" min="1" max="10" />
        </div>
        <button type="submit">Khởi tạo hóa đơn</button>
    </form>
</section>

@section Scripts {
    <partial name="_ValidationScriptsPartial" />
}
