@model Ecommerce.Web.ViewModels.ProductDetailViewModel

@{
    ViewData["Title"] = Model.Name;
}

    <div class="product-detail-wrapper">
        <!-- Left: Gallery (Thumbnails Left + Main Right) -->
        <div class="gallery-container">
            <div class="gallery-thumbnails">
                @if (Model.Images.Any())
                {
                    @for (int i = 0; i < Model.Images.Count; i++)
                    {
                        var activeClass = i == 0 ? "active" : "";
                        <img src="@Model.Images[i]" class="thumb-img @activeClass" onclick="changeImage(this, '@Model.Images[i]')" />
                    }
                }
            </div>
            <div class="gallery-main">
                 <img src="@(Model.Images.FirstOrDefault() ?? "https://placehold.co/600x800?text=No+Image")" id="mainProductImage" alt="@Model.Name" style="cursor: pointer;" onclick="openLightbox()" />
            </div>
        </div>

        <script>
            function changeImage(element, src) {
                // Update Main Image
                document.getElementById('mainProductImage').src = src;
                
                // Update Active Styling
                var thumbs = document.querySelectorAll('.thumb-img');
                thumbs.forEach(t => t.classList.remove('active'));
                element.classList.add('active');
            }

            function updateQuantity(change) {
                var qtyInput = document.getElementById('quantity');
                var currentQty = parseInt(qtyInput.value) || 1;
                var newQty = currentQty + change;
                var max = parseInt(qtyInput.max) || 999;
                var min = parseInt(qtyInput.min) || 1;
                
                // Respect min and max boundaries
                if (newQty < min) newQty = min;
                if (newQty > max) newQty = max;
                
                qtyInput.value = newQty;
            }

            function applyCoupon(code) {
                // TODO: Implement coupon logic
                alert('Đã áp dụng mã giảm giá: ' + code);
                // You can add logic here to:
                // - Validate coupon code
                // - Apply discount to price
                // - Update UI to show applied coupon
            }
        </script>

        <!-- Right: Sticky Product Info -->
        <div class="product-info-sticky">
            <div>
                <h1 class="product-title">@Model.Name</h1>
                <br>
                <p class="product-sku" id="product-sku" style="display: none;">SKU: <span id="variant-sku"></span></p>
                <div class="product-price-section">
                    @if (Model.OriginalPrice.HasValue && Model.OriginalPrice > Model.Price)
                    {
                        <div class="product-price-original">@Model.OriginalPrice.Value.ToString("C0", new System.Globalization.CultureInfo("vi-VN"))</div>
                    }
                    <div class="product-price-details">
                        <p class="product-price">@Model.Price.ToString("C0", new System.Globalization.CultureInfo("vi-VN"))</p>
                        @if (Model.OriginalPrice.HasValue && Model.OriginalPrice > Model.Price)
                        {
                            var savings = Math.Round(100 * (-1 + Model.Price / Model.OriginalPrice.Value));
                            <span class="product-price-discount"> @savings%</span>
                        }
                    </div>
                </div>
                @if (Model.OriginalPrice.HasValue && Model.OriginalPrice > Model.Price){
                    <div class="product-savings">Miễn phí vận chuyển</div>
                }

                <!-- Discount Coupons -->
                @if (Model.AvailableCoupons.Any())
                {
                    <div class="coupon-section">
                        <div class="coupon-label">Mã giảm giá</div>
                        <div class="coupon-list">
                            @foreach (var coupon in Model.AvailableCoupons)
                            {
                                <button class="coupon-tag" 
                                        onclick="applyCoupon('@coupon.Code')"
                                        title="@coupon.Description">
                                    @if (coupon.DiscountAmount > 0)
                                    {
                                        <text>Giảm @((coupon.DiscountAmount / 1000).ToString("0"))K</text>
                                    }
                                    else if (coupon.DiscountPercentage.HasValue)
                                    {
                                        <text>Giảm @coupon.DiscountPercentage%</text>
                                    }
                                </button>
                            }
                        </div>
                    </div>
                }
            </div>

            @* Product Variants Selector *@
            @await Html.PartialAsync("_VariantSelector", Model.Variants)

            @* Actions *@
            <div class="quantity-selector-group" style="margin-bottom: 20px;">
                <label style="margin-bottom: 8px; display: block; font-weight: 600;">Số lượng</label>
                <div class="quantity-selector">
                    <button class="qty-btn minus" type="button" onclick="updateQuantity(-1)">-</button>
                    <input type="number" id="quantity" value="1" min="1" class="qty-input" />
                    <button class="qty-btn plus" type="button" onclick="updateQuantity(1)">+</button>
                </div>
            </div>
            <div class="product-actions">
                <button class="btn btn-block btn-outline add-to-cart-btn" onclick="addToCart('@Model.Id', document.getElementById('quantity').value, document.getElementById('selectedVariantId').value)">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="vertical-align: middle; margin-right: 3px;">
                        <circle cx="9" cy="21" r="1"></circle>
                        <circle cx="20" cy="21" r="1"></circle>
                        <path d="M1 1h4l2.68 13.39a2 2 0 0 0 2 1.61h9.72a2 2 0 0 0 2-1.61L23 6H6"></path>
                    </svg>
                    Thêm vào giỏ hàng
                </button>
                <button class="btn btn-block btn-primary" onclick="buyNow('@Model.Id', document.getElementById('quantity').value, document.getElementById('selectedVariantId').value)">Mua ngay</button>
            </div>
        </div>
    </div>

    <!-- Detailed Description Section - Full Width with Expandable Content -->
    <div class="product-description-section">
        <h3 class="description-title">@Model.Name</h3>
        <div class="description-content" id="descriptionContent">
            <div class="description-text">
                @Model.Description
                <br/><br/>
                Là một sản phẩm không thể thiếu được để tạo nên outfit hoàn hảo cho outfit hằng ngày. Áo Phao Dày Ultrawarm Puffer Gile II là sự kết hợp hoàn hảo giữa khả năng giữ ấm vượt trội với phong cách năng động hiện đại. Được làm từ chất liệu cao cấp với công nghệ cách nhiệt tiên tiến, áo phù hợp với thời tiết lạnh giá nhất. Đường may tỉ mỉ cùng kiểu dáng hiện đại, áo mang đến cảm giác thời trang, mà tôi luôn mong muốn- một món đồ sang trọng, cổ điển và hợp thời trang. Là một phần tách rời mà bạn sẽ nhớ đến trong mùa đông -  một điều không thể bỏ qua vào những ngày se lạnh. Phong cách chung cho cả nam và nữ nhưng lại không bao giờ lỗi thời. Dáng áo phong phú và thời thượng.
            </div>
        </div>
        <button class="btn-show-more" id="btnShowMore" onclick="toggleDescription()">
            XEM THÊM
        </button>
    </div>

    <script>
        function toggleDescription() {
            const content = document.getElementById('descriptionContent');
            const btn = document.getElementById('btnShowMore');
            
            if (content.classList.contains('expanded')) {
                content.classList.remove('expanded');
                btn.textContent = 'XEM THÊM';
            } else {
                content.classList.add('expanded');
                btn.textContent = 'THU GỌN';
            }
        }
    </script>

    <!-- Related Products -->
    @if (Model.RelatedProducts.Any())
    {
        <section class="section related-products" style="margin-top: 80px;">
            <div class="section-header">
                <h3>Có thể bạn cũng thích</h3>
            </div>
            <div class="product-slider-wrapper" style="padding:0; margin-left:0; width:100%; max-width:100%;">
                 <div class="product-slider" style="padding-left:0;">
                    @foreach (var product in Model.RelatedProducts)
                    {
                        <article class="product-card" style="min-width: 250px; flex: 0 0 250px;">
                            <a asp-controller="Product" asp-action="Details" asp-route-id="@product.Id" class="product-link">
                                <img src="@product.HeroImageUrl" alt="@product.Name" loading="lazy" style="height: 320px;" />
                                <div class="card-body">
                                    <div class="card-meta">
                                        <p class="eyebrow">Gợi ý</p>
                                        <h3>@product.Name</h3>
                                        <div class="price">@product.Price.ToString("C0", new System.Globalization.CultureInfo("vi-VN"))</div>
                                    </div>
                                </div>
                            </a>
                        </article>
                    }
                </div>
            </div>
        </section>
    }

<!-- Image Lightbox Modal -->
<div id="lightboxModal" class="lightbox-modal">
    <button class="lightbox-close" onclick="closeLightbox()">&times;</button>
    <div class="lightbox-content">
        <div class="lightbox-main">
            <button class="lightbox-nav prev" onclick="navigateLightbox(-1)">&#8249;</button>
            <img id="lightboxImage" src="" alt="Product Image" />
            <button class="lightbox-nav next" onclick="navigateLightbox(1)">&#8250;</button>
        </div>
        <div class="lightbox-thumbnails" id="lightboxThumbnails">
            <!-- Thumbnails will be populated by JavaScript -->
        </div>
    </div>
</div>

<script>
    let currentLightboxIndex = 0;
    let lightboxImages = [];

    function openLightbox() {
        // Collect all images from the gallery
        const thumbs = document.querySelectorAll('.thumb-img');
        lightboxImages = Array.from(thumbs).map(thumb => {
            const onclickAttr = thumb.getAttribute('onclick');
            const match = onclickAttr.match(/'([^']+)'/);
            return match ? match[1] : '';
        });

        // Find current active image index
        const activeThumb = document.querySelector('.thumb-img.active');
        if (activeThumb) {
            const activeOnclick = activeThumb.getAttribute('onclick');
            const activeMatch = activeOnclick.match(/'([^']+)'/);
            const activeSrc = activeMatch ? activeMatch[1] : '';
            currentLightboxIndex = lightboxImages.indexOf(activeSrc);
            if (currentLightboxIndex === -1) currentLightboxIndex = 0;
        }

        // Populate thumbnails
        const thumbnailsContainer = document.getElementById('lightboxThumbnails');
        thumbnailsContainer.innerHTML = '';
        lightboxImages.forEach((src, index) => {
            const img = document.createElement('img');
            img.src = src;
            img.className = 'lightbox-thumb' + (index === currentLightboxIndex ? ' active' : '');
            img.onclick = () => setLightboxImage(index);
            thumbnailsContainer.appendChild(img);
        });

        // Set initial image
        updateLightboxImage();

        // Show modal
        document.getElementById('lightboxModal').classList.add('active');
        document.body.style.overflow = 'hidden';
    }

    function closeLightbox() {
        document.getElementById('lightboxModal').classList.remove('active');
        document.body.style.overflow = '';
    }

    function navigateLightbox(direction) {
        currentLightboxIndex += direction;
        if (currentLightboxIndex < 0) currentLightboxIndex = lightboxImages.length - 1;
        if (currentLightboxIndex >= lightboxImages.length) currentLightboxIndex = 0;
        updateLightboxImage();
    }

    function setLightboxImage(index) {
        currentLightboxIndex = index;
        updateLightboxImage();
    }

    function updateLightboxImage() {
        const img = document.getElementById('lightboxImage');
        img.src = lightboxImages[currentLightboxIndex];

        // Update active thumbnail
        const thumbs = document.querySelectorAll('.lightbox-thumb');
        thumbs.forEach((thumb, index) => {
            thumb.classList.toggle('active', index === currentLightboxIndex);
        });
    }

    // Close on outside click
    document.getElementById('lightboxModal').addEventListener('click', function(e) {
        if (e.target === this) {
            closeLightbox();
        }
    });

    // Keyboard navigation
    document.addEventListener('keydown', function(e) {
        const modal = document.getElementById('lightboxModal');
        if (!modal.classList.contains('active')) return;

        if (e.key === 'Escape') {
            closeLightbox();
        } else if (e.key === 'ArrowLeft') {
            navigateLightbox(-1);
        } else if (e.key === 'ArrowRight') {
            navigateLightbox(1);
        }
    });
</script>
