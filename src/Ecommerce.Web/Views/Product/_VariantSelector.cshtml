@model List<Ecommerce.Web.ViewModels.ProductVariantViewModel>

@if (Model != null && Model.Any())
{
    var colors = Model.Where(v => !string.IsNullOrEmpty(v.Color)).Select(v => v.Color).Distinct().ToList();
    var sizes = Model.Where(v => !string.IsNullOrEmpty(v.Size)).Select(v => v.Size).Distinct().ToList();
    
    <div class="product-variants mb-4">
        @* Color Selector *@
        @if (colors.Any())
        {
            <div class="mb-3">
                <label class="fw-bold d-block mb-2">
                    <i class="bi bi-palette"></i> Màu sắc:
                </label>
                <div class="color-options">
                    @foreach (var color in colors)
                    {
                        var variant = Model.FirstOrDefault(v => v.Color == color);
                        var hasStock = Model.Any(v => v.Color == color && v.Stock > 0);
                        var btnClass = hasStock ? "btn-outline-primary" : "btn-outline-secondary disabled";
                        
                        <button type="button" 
                                class="btn @btnClass color-btn me-2 mb-2" 
                                data-color="@color"
                                @(hasStock ? "" : "disabled")>
                            @color
                            @if (!hasStock)
                            {
                                <small class="text-muted">(Hết)</small>
                            }
                        </button>
                    }
                </div>
            </div>
        }
        
        @* Size Selector *@
        @if (sizes.Any())
        {
            <div class="mb-3">
                <label class="fw-bold d-block mb-2">
                    <i class="bi bi-rulers"></i> Kích thước:
                </label>
                <div class="size-options">
                    @foreach (var size in sizes)
                    {
                        var hasStock = Model.Any(v => v.Size == size && v.Stock > 0);
                        var btnClass = hasStock ? "btn-outline-primary" : "btn-outline-secondary disabled";
                        
                        <button type="button" 
                                class="btn @btnClass size-btn me-2 mb-2" 
                                data-size="@size"
                                @(hasStock ? "" : "disabled")>
                            @size
                            @if (!hasStock)
                            {
                                <small>(Hết)</small>
                            }
                        </button>
                    }
                </div>
            </div>
        }
        
        @* Stock Display *@
        <div class="stock-info mb-3">
            <span class="stock-status text-muted">
                <i class="bi bi-box-seam"></i> Vui lòng chọn @(colors.Any() ? "màu" : "") @(colors.Any() && sizes.Any() ? "và " : "")@(sizes.Any() ? "size" : "") để xem tồn kho
            </span>
        </div>
        
        @* Selected Variant Details *@
        <div class="variant-details d-none">
            <div class="alert alert-info">
                <strong>SKU:</strong> <span id="selected-sku">-</span><br>
                <strong>Tồn kho:</strong> <span id="selected-stock">-</span>
            </div>
        </div>
    </div>
    
    @* Hidden field for selected variant ID *@
    <input type="hidden" id="selectedVariantId" name="variantId" value="">
    
    @* Variants data as JSON for JavaScript *@
    <script id="variantsData" type="application/json">
        @Html.Raw(System.Text.Json.JsonSerializer.Serialize(Model))
    </script>
    
    <style>
        .color-btn.active, .size-btn.active {
            background-color: #007bff !important;
            color: white !important;
            border-color: #007bff !important;
        }
        .color-btn:not(.disabled):hover, .size-btn:not(.disabled):hover {
            background-color: #f8f9fa;
        }
    </style>
    
    <script>
    (function() {
        // Parse variants data
        const variantsJson = document.getElementById('variantsData').textContent;
        const variantsData = JSON.parse(variantsJson);
        
        console.log('Variants loaded:', variantsData);
        
        // Save original product price
        let originalProductPrice = '';
        const priceEl = document.querySelector('.product-price');
        if (priceEl) {
            originalProductPrice = priceEl.textContent;
        }
        
        // Save original product images
        let originalProductImages = [];
        const thumbnailContainer = document.querySelector('.gallery-thumbnails');
        if (thumbnailContainer) {
            const thumbs = thumbnailContainer.querySelectorAll('.thumb-img');
            thumbs.forEach(thumb => {
                originalProductImages.push({
                    src: thumb.src,
                    isActive: thumb.classList.contains('active')
                });
            });
        }
        
        // Function to restore original product images
        window.restoreProductImages = function() {
            const mainImage = document.getElementById('mainProductImage');
            const thumbnailContainer = document.querySelector('.gallery-thumbnails');
            
            if (thumbnailContainer && originalProductImages.length > 0) {
                thumbnailContainer.innerHTML = '';
                
                originalProductImages.forEach((imgData, index) => {
                    const thumb = document.createElement('img');
                    thumb.src = imgData.src;
                    thumb.className = 'thumb-img' + (imgData.isActive ? ' active' : '');
                    thumb.onclick = function() {
                        if (mainImage) mainImage.src = imgData.src;
                        document.querySelectorAll('.thumb-img').forEach(t => t.classList.remove('active'));
                        this.classList.add('active');
                    };
                    thumbnailContainer.appendChild(thumb);
                });
                
                // Restore main image to first original
                if (mainImage && originalProductImages.length > 0) {
                    const activeImg = originalProductImages.find(img => img.isActive);
                    mainImage.src = activeImg ? activeImg.src : originalProductImages[0].src;
                }
            }
        }
        
        // Selection state
        let selectedColor = null;
        let selectedSize = null;
        
        // Color selection
        document.querySelectorAll('.color-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                document.querySelectorAll('.color-btn').forEach(b => b.classList.remove('active'));
                this.classList.add('active');
                selectedColor = this.dataset.color;
                
                // Auto-select first available size for this color
                const firstMatchingVariant = variantsData.find(v => 
                    v.Color && v.Color.toLowerCase() === selectedColor.toLowerCase()
                );
                
                if (firstMatchingVariant && firstMatchingVariant.Size) {
                    // Find and click the size button
                    const sizeBtn = document.querySelector(`.size-btn[data-size="${firstMatchingVariant.Size}"]`);
                    if (sizeBtn) {
                        sizeBtn.click();
                        return; // Size click will trigger updateVariantSelection
                    }
                }
                
                updateVariantSelection();
            });
        });
        
        // Size selection
        document.querySelectorAll('.size-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                document.querySelectorAll('.size-btn').forEach(b => b.classList.remove('active'));
                this.classList.add('active');
                selectedSize = this.dataset.size;
                updateVariantSelection();
            });
        });
        
        function updateVariantSelection() {
            console.log('Selected:', { color: selectedColor, size: selectedSize });
            
            // Find matching variant
            const variant = variantsData.find(v => 
                (selectedColor === null || v.Color === selectedColor) &&
                (selectedSize === null || v.Size === selectedSize)
            );
            
            console.log('Found variant:', variant);
            
            if (variant) {
                document.getElementById('selectedVariantId').value = variant.Id;
                
                // Update SKU display
                const skuElement = document.getElementById('product-sku');
                const skuSpan = document.getElementById('variant-sku');
                if (skuElement && skuSpan && variant.SKU) {
                    skuSpan.textContent = variant.SKU;
                    skuElement.style.display = 'block';
                }
                
                // Update variant details (old compatibility)
                const oldSkuEl = document.getElementById('selected-sku');
                if (oldSkuEl) oldSkuEl.textContent = variant.SKU;
                
                const stockEl = document.getElementById('selected-stock');
                if (stockEl) stockEl.textContent = variant.Stock + ' sản phẩm';
                
                // Update stock status
                const stockStatus = document.querySelector('.stock-status');
                if (variant.Stock > 0) {
                    stockStatus.innerHTML = `<i class="bi bi-check-circle text-success"></i> Còn <strong>${variant.Stock}</strong> sản phẩm`;
                } else {
                    stockStatus.innerHTML = `<i class="bi bi-x-circle text-danger"></i> <strong>Hết hàng</strong>`;
                }
                
                // Show variant details
                document.querySelector('.variant-details').classList.remove('d-none');
                
                // Update entire gallery if variant has custom images
                if (variant.ImageUrls && variant.ImageUrls.length > 0) {
                    console.log('Updating gallery to variant images:', variant.ImageUrls);
                    
                    // Update main image with first variant image
                    const mainImage = document.getElementById('mainProductImage');
                    if (mainImage) {
                        mainImage.src = variant.ImageUrls[0];
                    }
                    
                    // Replace all thumbnails with variant images
                    const thumbnailContainer = document.querySelector('.gallery-thumbnails');
                    if (thumbnailContainer) {
                        // Clear existing thumbnails
                        thumbnailContainer.innerHTML = '';
                        
                        // Add all variant image thumbnails
                        variant.ImageUrls.forEach((url, index) => {
                            const thumb = document.createElement('img');
                            thumb.src = url;
                            thumb.className = 'thumb-img' + (index === 0 ? ' active' : '');
                            thumb.onclick = function() {
                                // Update Main Image
                                if (mainImage) mainImage.src = url;
                                // Update Active Styling
                                document.querySelectorAll('.thumb-img').forEach(t => t.classList.remove('active'));
                                this.classList.add('active');
                            };
                            thumbnailContainer.appendChild(thumb);
                        });
                    }
                    
                    console.log('Gallery updated with variant images!');
                } else {
                    // Variant exists but has no images - restore product images
                    console.log('Variant has no images, restoring product images');
                    restoreProductImages();
                }
                
                // Update price if variant has custom price
                if (variant.Price) {
                    const priceEl = document.querySelector('.product-price');
                    if (priceEl) {
                        priceEl.textContent = new Intl.NumberFormat('vi-VN', { style: 'currency', currency: 'VND' }).format(variant.Price);
                    }
                }
                
                // Reset quantity based on stock
                const quantityInput = document.getElementById('quantity');
                if (quantityInput) {
                    quantityInput.value = variant.Stock > 0 ? 1 : 0;
                    quantityInput.max = variant.Stock;
                }
                
                // Enable add to cart button
                const addToCartBtn = document.querySelector('.add-to-cart-btn');
                if (addToCartBtn) {
                    addToCartBtn.disabled = variant.Stock === 0;
                }
            } else {
                document.getElementById('selectedVariantId').value = '';
                document.querySelector('.variant-details').classList.add('d-none');
                
                // Hide SKU when no variant
                const skuElement = document.getElementById('product-sku');
                if (skuElement) {
                    skuElement.style.display = 'none';
                }
                
                // Restore original product images when no variant match
                restoreProductImages();
                
                // Update stock status to 0
                const stockStatus = document.querySelector('.stock-status');
                if (stockStatus) {
                    stockStatus.innerHTML = '<i class="bi bi-x-circle text-danger"></i> <strong>0 sản phẩm</strong> - Không có sẵn';
                }
                
                // Restore original product price
                const priceEl = document.querySelector('.product-price');
                if (priceEl && originalProductPrice) {
                    priceEl.textContent = originalProductPrice;
                }
                
                // Reset quantity to 0
                const quantityInput = document.getElementById('quantity');
                if (quantityInput) {
                    quantityInput.value = 0;
                    quantityInput.max = 0;
                }
                
                // Disable Add to Cart button
                const addToCartBtn = document.querySelector('.add-to-cart-btn');
                if (addToCartBtn) {
                    addToCartBtn.disabled = true;
                }
            }
        }
        
        // Auto-select first available variant on page load
        (function autoSelectFirstAvailableVariant() {
            // Find first variant with stock > 0
            const firstAvailable = variantsData.find(v => v.Stock > 0);
            
            if (firstAvailable) {
                // Auto-select color if available
                if (firstAvailable.Color) {
                    const colorBtn = document.querySelector(`.color-btn[data-color="${firstAvailable.Color}"]`);
                    if (colorBtn) {
                        colorBtn.click();
                    }
                }
                
                // Auto-select size if available
                if (firstAvailable.Size) {
                    const sizeBtn = document.querySelector(`.size-btn[data-size="${firstAvailable.Size}"]`);
                    if (sizeBtn) {
                        sizeBtn.click();
                    }
                }
            }
        })();
    })();
    </script>
}
else
{
    <div class="alert alert-warning">
        <i class="bi bi-exclamation-triangle"></i> Sản phẩm chưa có biến thể. Vui lòng liên hệ admin để thêm size/màu sắc.
    </div>
}
