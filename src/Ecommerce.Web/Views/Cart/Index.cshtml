@model Ecommerce.Web.ViewModels.CartViewModel

@{
    ViewData["Title"] = "Gi·ªè h√†ng";
}

<style>
    .checkout-container {
        max-width: 1400px;
        margin: 20px auto;
        padding: 0 15px;
        background: #f9fafb;
    }
    
    .checkout-section {
        background: white;
        border: 1px solid #e5e7eb;
        border-radius: 12px;
        padding: 24px;
        margin-bottom: 24px;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
        transition: box-shadow 0.2s;
    }
    
    .checkout-section:hover {
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
    }
    
    .section-title {
        font-size: 20px;
        font-weight: 700;
        margin-bottom: 20px;
        color: #111827;
        padding-bottom: 12px;
        border-bottom: 2px solid #f3f4f6;
    }
    
    .form-row {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 16px;
        margin-bottom: 16px;
    }
    
    .form-group {
        display: flex;
        flex-direction: column;
    }
    
    .form-group label {
        font-size: 14px;
        font-weight: 400;
        margin-bottom: 8px;
        color: #374151;
    }
    
    .form-group label .required {
        color: #ef4444;
    }
    
    .form-group input,
    .form-group select {
        padding: 14px 18px;
        border: 1px solid #d1d5db;
        border-radius: 24px;
        font-size: 14px;
        width: 100%;
        transition: all 0.2s;
    }
    
    .form-group input:focus,
    .form-group select:focus {
        outline: none;
        border-color: #9ca3af;
        box-shadow: none;
    }
    
    .cart-items-container {
        max-height: 400px;
        overflow-y: auto;
        border-top: 1px solid #e5e7eb;
        border-bottom: 1px solid #e5e7eb;
    }
    
    .cart-item-new {
        display: flex;
        align-items: flex-start;
        gap: 16px;
        padding: 16px;
        border-bottom: 1px solid #e5e7eb;
        margin-bottom: 0;
    }
    
    .cart-item-new:hover {
        background: #f9fafb;
    }
    
    .item-checkbox {
        appearance: none !important;
        -webkit-appearance: none !important;
        -moz-appearance: none !important;
        width: 20px !important;
        height: 20px !important;
        border: 2px solid #d1d5db !important;
        border-radius: 4px !important;
        cursor: pointer;
        margin-top: 60px;
        position: relative;
        background: white !important;
        transition: all 0.2s;
        flex-shrink: 0;
    }
    
    .item-checkbox:hover {
        border-color: #273BCE !important;
    }
    
    .item-checkbox:checked {
        background: #273BCE !important;
        border-color: #273BCE !important;
    }
    
    .item-checkbox:checked::after {
        content: '';
        position: absolute;
        left: 5px;
        top: 2px;
        width: 5px;
        height: 10px;
        border: solid white;
        border-width: 0 2px 2px 0;
        transform: rotate(45deg);
    }
    
    .item-image {
        width: 100px;
        height: 160px;
        object-fit: cover;
        border-radius: 8px;
        background: #f3f4f6;
    }
    
    .item-info {
        flex: 1;
        display: flex;
        flex-direction: column;
        gap: 8px;
    }
    
    .item-name {
        font-weight: 600;
        font-size: 16px;
        color: #1f2937;
        margin: 0;
    }
    
    .item-variant-info {
        font-size: 14px;
        color: #6b7280;
    }
    
    .item-variants {
        display: flex;
        gap: 8px;
        margin-top: 4px;
    }
    
    .variant-select {
        padding: 8px 12px;
        border: 1px solid #e5e7eb;
        border-radius: 6px;
        font-size: 14px;
        background: #f9fafb;
        cursor: pointer;
        min-width: 80px;
    }
    
    .variant-select:hover {
        background: #f3f4f6;
    }
    
    .item-controls {
        display: flex;
        align-items: center;
        gap: 12px;
        margin-top: auto;
    }
    
    .gift-badge {
        display: inline-block;
        background: #ff6b35;
        color: white;
        padding: 4px 8px;
        border-radius: 4px;
        font-size: 12px;
        font-weight: 600;
    }
    
    .qty-controls {
        display: flex;
        align-items: center;
        gap: 8px;
        border: 1px solid #d1d5db;
        border-radius: 6px;
        padding: 4px;
    }
    
    .qty-btn {
        width: 28px;
        height: 28px;
        border: none;
        background: #f3f4f6;
        border-radius: 4px;
        cursor: pointer;
        font-size: 16px;
        display: flex;
        align-items: center;
        justify-content: center;
    }
    
    .qty-btn:hover {
        background: #e5e7eb;
    }
    
    .qty-value {
        min-width: 30px;
        text-align: center;
        font-weight: 500;
    }
    
    .item-price-section {
        display: flex;
        flex-direction: column;
        align-items: flex-end;
        gap: 8px;
        min-width: 150px;
    }
    
    .item-price {
        text-align: right;
    }
    
    .price-current {
        font-size: 18px;
        font-weight: 700;
        color: #1f2937;
    }
    
    .price-original {
        font-size: 14px;
        color: #9ca3af;
        text-decoration: line-through;
        margin-bottom: 4px;
    }
    
    .item-remove {
        background: none;
        border: none;
        color: #6b7280;
        cursor: pointer;
        padding: 4px;
        font-size: 14px;
        text-decoration: underline;
    }
    
    .item-remove:hover {
        color: #ef4444;
    }
    
    .summary-row {
        display: flex;
        justify-content: space-between;
        padding: 12px 0;
        border-bottom: 1px solid #e5e7eb;
    }
    
    .summary-row:last-child {
        border-bottom: none;
    }
    
    /* Payment Summary Styles */
    .payment-summary {
        display: flex;
        flex-direction: column;
        gap: 16px;
    }
    
    .payment-row {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        padding-bottom: 16px;
        border-bottom: 1px solid #f3f4f6;
    }
    
    .payment-row:last-child {
        border-bottom: none;
    }
    
    .payment-label {
        font-size: 14px;
        color: #6b7280;
    }
    
    .payment-value {
        text-align: right;
        font-size: 14px;
        font-weight: 600;
        color: #111827;
    }
    
    .original-subtotal {
        display: block;
        font-size: 12px;
        font-weight: 400;
        color: #9ca3af;
        margin-top: 4px;
    }
    
    .payment-free {
        color: #10b981;
    }
    
    .payment-discount {
        color: #111827;
    }
    
    .payment-total {
        padding-top: 16px;
        border-top: 1px solid #e5e7eb;
        border-bottom: none !important;
    }
    
    .payment-total .payment-label {
        font-size: 16px;
        font-weight: 600;
        color: #111827;
    }
    
    .payment-value-total {
        text-align: right;
    }
    
    .payment-value-total strong {
        font-size: 18px;
        font-weight: 700;
        color: #111827;
        display: block;
    }
    
    .summary-row.total {
        font-size: 18px;
        font-weight: 600;
        padding-top: 16px;
        border-top: 2px solid #1f2937;
    }
    
    .payment-option {
        display: flex;
        align-items: center;
        padding: 12px;
        border: 2px solid #e5e7eb;
        border-radius: 8px;
        margin-bottom: 12px;
        cursor: pointer;
    }
    
    .payment-option:hover {
        border-color: #3b82f6;
        background: #eff6ff;
    }
    
    .payment-option input[type="radio"] {
        width: 20px;
        height: 20px;
        margin-right: 12px;
    }
    
    /* E-Wallet Selection Styles */
    .ewallet-item {
        cursor: pointer;
        display: block;
    }
    
    .ewallet-radio {
        display: none;
    }
    
    .ewallet-card {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 6px;
        padding: 10px;
        border: 2px solid #e5e7eb;
        border-radius: 8px;
        background: white;
        transition: all 0.2s;
    }
    
    .ewallet-item:hover .ewallet-card {
        border-color: #3b82f6;
        box-shadow: 0 2px 8px rgba(59, 130, 246, 0.1);
        transform: translateY(-2px);
    }
    
    .ewallet-radio:checked + .ewallet-card {
        border-color: #3b82f6;
        background: #eff6ff;
        box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
    }
    
    .ewallet-icon {
        width: 32px;
        height: 32px;
        border-radius: 8px;
        display: flex;
        align-items: center;
        justify-content: center;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }
    
    .ewallet-name {
        font-size: 12px;
        font-weight: 600;
        color: #374151;
    }
    
    .btn-checkout {
        width: 100%;
        padding: 16px;
        background: #3b82f6;
        color: white;
        border: none;
        border-radius: 8px;
        font-size: 16px;
        font-weight: 600;
        cursor: pointer;
        transition: background 0.2s;
    }
    
    .btn-checkout:hover {
        background: #2563eb;
    }
    
    .select-all-row {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 12px;
        background: #f9fafb;
        border-radius: 8px;
        margin-bottom: 16px;
    }
    
    .select-all-label {
        display: flex;
        align-items: center;
        gap: 8px;
        font-weight: 500;
    }
    
    .btn-clear-all {
        color: #ef4444;
        background: none;
        border: none;
        cursor: pointer;
        font-size: 14px;
    }
    
    /* Coupon Styles */
    .coupon-list {
        display: flex;
        gap: 12px;
        overflow-x: auto;
        padding-bottom: 12px;
        margin-bottom: 16px;
    }
    
    .coupon-card {
        min-width: 300px;
        background: white;
        border: 2px dashed #ff6b35;
        border-radius: 8px;
        padding: 12px 16px;
        position: relative;
        transition: all 0.2s;
        cursor: pointer;
    }
    
    .coupon-card:hover {
        border-color: #ff4500;
        background: #fff5f0;
    }
    
    .coupon-radio:checked + .coupon-label .coupon-card,
    .coupon-card:has(.coupon-radio:checked) {
        background: #fff5f0;
        border-color: #ff4500;
        border-width: 2px;
        box-shadow: 0 2px 8px rgba(255, 107, 53, 0.2);
    }
    
    .coupon-radio {
        position: absolute;
        top: 16px;
        right: 16px;
        width: 20px;
        height: 20px;
        cursor: pointer;
    }
    
    .coupon-label {
        display: flex;
        flex-direction: column;
        gap: 12px;
        cursor: pointer;
    }
    
    .coupon-info {
        padding-right: 30px;
    }
    
    .coupon-code {
        font-size: 16px;
        font-weight: 700;
        color: #111827;
        margin-bottom: 6px;
    }
    
    .coupon-condition {
        font-size: 13px;
        font-weight: 400;
        color: #6b7280;
    }
    
    .coupon-desc {
        font-size: 13px;
        color: #374151;
        line-height: 1.4;
        margin-bottom: 6px;
    }
    
    .coupon-expiry {
        font-size: 12px;
        color: #2563eb;
    }
    
    .btn-condition {
        align-self: flex-end;
        padding: 6px 16px;
        background: white;
        border: 1px solid #d1d5db;
        border-radius: 6px;
        font-size: 13px;
        color: #2563eb;
        cursor: pointer;
        transition: all 0.2s;
    }
    
    .btn-condition:hover {
        background: #eff6ff;
        border-color: #2563eb;
    }
    
    .coupon-input-wrapper {
        display: flex;
        gap: 12px;
        align-items: center;
    }
    
    .coupon-input {
        flex: 1;
        padding: 14px 18px;
        border: 1px solid #d1d5db;
        border-radius: 24px;
        font-size: 14px;
        transition: all 0.2s;
    }
    
    .coupon-input:focus {
        outline: none;
        border-color: #9ca3af;
    }
    
    .btn-apply-coupon {
        padding: 14px 32px;
        background: #111827;
        color: white;
        border: none;
        border-radius: 24px;
        font-size: 14px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s;
        white-space: nowrap;
    }
    
    .btn-apply-coupon:hover {
        background: #1f2937;
    }
</style>

<div class="checkout-container">
    <h1 style="margin-bottom: 30px;">Gi·ªè h√†ng</h1>
    
    @if (Model.Items.Any())
    {
        <form method="post" asp-action="Checkout">
            <!-- 1. TH√îNG TIN V·∫¨N CHUY·ªÇN -->
            <div class="checkout-section">
                <h2 class="section-title">Th√¥ng tin v·∫≠n chuy·ªÉn</h2>
                
                <div class="form-row" style="grid-template-columns: 1fr 1fr 1fr;">
                    <div class="form-group">
                        <label>H·ªç t√™n <span class="required">*</span></label>
                        <input type="text" name="CustomerName" value="@Model.CustomerName" placeholder="Nh·∫≠p h·ªç t√™n c·ªßa b·∫°n" required />
                    </div>
                    <div class="form-group">
                        <label>S·ªë ƒëi·ªán tho·∫°i <span class="required">*</span></label>
                        <input type="tel" name="CustomerPhone" value="@Model.CustomerPhone" placeholder="Nh·∫≠p s·ªë ƒëi·ªán tho·∫°i" required />
                    </div>
                    <div class="form-group">
                        <label>Email</label>
                        <input type="email" name="CustomerEmail" value="@Model.CustomerEmail" placeholder="Nh·∫≠p email c·ªßa b·∫°n" />
                    </div>
                </div>
                
                <div class="form-group" style="margin-bottom: 16px;">
                    <label>ƒê·ªãa ch·ªâ giao h√†ng <span class="required">*</span></label>
                    @if (Model.AvailableAddresses.Any())
                    {
                        <select name="ShippingAddress" required>
                            @foreach (var address in Model.AvailableAddresses)
                            {
                                <option value="@address" selected="@(address == Model.ShippingAddress)">@address</option>
                            }
                            <option value="">Nh·∫≠p ƒë·ªãa ch·ªâ kh√°c...</option>
                        </select>
                        <input type="text" id="customAddress" placeholder="Nh·∫≠p ƒë·ªãa ch·ªâ m·ªõi" style="margin-top: 8px; display: none;" />
                    }
                    else
                    {
                        <input type="text" name="ShippingAddress" value="@Model.ShippingAddress" placeholder="Nh·∫≠p ƒë·ªãa ch·ªâ giao h√†ng" required />
                    }
                </div>
                
                <div class="form-group">
                    <label>Ghi ch√∫</label>
                    <input type="text" name="Note" placeholder="Ghi ch√∫ cho ƒë∆°n h√†ng (t√πy ch·ªçn)" />
                </div>
            </div>
            
            <!-- 2. GI·ªé H√ÄNG -->
            <div class="checkout-section">
                <h2 class="section-title">Gi·ªè h√†ng</h2>
                
                <div class="select-all-row">
                    <label class="select-all-label">
                        <input type="checkbox" class="item-checkbox" id="selectAll" onclick="toggleSelectAll(this)" />
                        <span>T·∫•t c·∫£ s·∫£n ph·∫©m (@Model.Items.Count)</span>
                    </label>
                    <button type="button" class="btn-clear-all" onclick="clearAll()">X√≥a t·∫•t c·∫£</button>
                </div>
                
                <div class="cart-items-container">
                    @foreach (var item in Model.Items)
                    {
                        <div class="cart-item-new" data-item-id="@item.Id">
                            <input type="checkbox" class="item-checkbox" checked />
                            
                            <img src="@item.ProductImageUrl" alt="@item.ProductName" class="item-image" />
                            
                            <div class="item-info">
                                <div class="item-name">@item.ProductName</div>
                                
                                @if (!string.IsNullOrEmpty(item.VariantColor) || !string.IsNullOrEmpty(item.VariantSize))
                                {
                                    <div class="item-variant-info">
                                        @if (!string.IsNullOrEmpty(item.VariantColor))
                                        {
                                            <span>@item.VariantColor</span>
                                        }
                                        @if (!string.IsNullOrEmpty(item.VariantColor) && !string.IsNullOrEmpty(item.VariantSize))
                                        {
                                            <span> / </span>
                                        }
                                        @if (!string.IsNullOrEmpty(item.VariantSize))
                                        {
                                            <span>@item.VariantSize</span>
                                        }
                                    </div>
                                    
                                    <div class="item-variants">
                                        @if (!string.IsNullOrEmpty(item.VariantColor))
                                        {
                                            <select class="variant-select">
                                                <option selected>@item.VariantColor</option>
                                            </select>
                                        }
                                        @if (!string.IsNullOrEmpty(item.VariantSize))
                                        {
                                            <select class="variant-select">
                                                <option selected>@item.VariantSize</option>
                                            </select>
                                        }
                                    </div>
                                }
                                
                                <div class="item-controls">
                                    <button type="button" class="item-remove" onclick="removeItem('@item.Id')">
                                        X√≥a
                                    </button>
                                </div>
                            </div>
                            
                            <div class="qty-controls">
                                <button type="button" class="qty-btn" onclick="adjustQuantity('@item.Id', -1)">‚àí</button>
                                <span class="qty-value">@item.Quantity</span>
                                <button type="button" class="qty-btn" onclick="adjustQuantity('@item.Id', 1)">+</button>
                            </div>
                            
                            <div class="item-price-section">
                                <div class="item-price">
                                    @if (item.OriginalPrice.HasValue && item.OriginalPrice.Value > 0 && item.OriginalPrice.Value > item.UnitPrice)
                                    {
                                        <div class="price-original">@((item.OriginalPrice.Value * item.Quantity).ToString("N0"))ƒë</div>
                                    }
                                    <div class="price-current">@item.LineTotal.ToString("N0")ƒë</div>
                                </div>
                            </div>
                        </div>
                    }
                </div>
            </div>
            
            <div class="checkout-section">
                <h2 class="section-title">M√£ gi·∫£m gi√°</h2>
                
                @if (string.IsNullOrEmpty(Model.AppliedCouponCode))
                {
                    <!-- Danh s√°ch m√£ gi·∫£m gi√° c√≥ s·∫µn -->
                    @if (Model.AvailableCoupons.Any())
                    {
                        <div class="coupon-list">
                            @foreach (var coupon in Model.AvailableCoupons)
                            {
                                <div class="coupon-card">
                                    <input type="radio" name="selectedCoupon" value="@coupon.Code" id="coupon_@coupon.Code" class="coupon-radio">
                                    <label for="coupon_@coupon.Code" class="coupon-label">
                                        <div class="coupon-info">
                                            <div class="coupon-code">@coupon.Code <span class="coupon-condition">(C√≤n @coupon.RemainingUsage)</span></div>
                                            <div class="coupon-desc">@coupon.FormattedDiscount @coupon.FormattedMinOrder</div>
                                            <div class="coupon-expiry">HSD: @coupon.EndDate.ToString("dd/MM/yyyy")</div>
                                        </div>
                                    </label>
                                </div>
                            }
                        </div>
                    }
                    
                    <!-- √î nh·∫≠p m√£ gi·∫£m gi√° -->
                    <div class="coupon-input-wrapper">
                        <input type="text" id="couponCodeInput" placeholder="Nh·∫≠p m√£ gi·∫£m gi√°" class="coupon-input" />
                        <button type="button" onclick="applyCoupon()" class="btn-apply-coupon">√ÅP D·ª§NG</button>
                    </div>
                }
                else
                {
                    <div style="display: flex; align-items: center; justify-content: space-between; padding: 12px; background: #ecfdf5; border: 1px solid #10b981; border-radius: 8px;">
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <span style="color: #10b981;">‚úì</span>
                            <span style="font-weight: 600; color: #065f46;">@Model.AppliedCouponCode</span>
                            <span style="color: #059669;">- Gi·∫£m @Model.Discount.ToString("N0")ƒë</span>
                        </div>
                        <button type="button" onclick="removeCoupon()" style="background: none; border: none; color: #6b7280; cursor: pointer;">
                            ‚úï
                        </button>
                    </div>
                }
            </div>
            
            <!-- 4. CHI TI·∫æT THANH TO√ÅN -->
            <div class="checkout-section">
                <h2 class="section-title">Chi ti·∫øt thanh to√°n</h2>
                
                <div class="payment-summary">
                    <div class="payment-row">
                        <span class="payment-label">T·∫°m t√≠nh</span>
                        <div class="payment-value">
                            <span id="subtotal">@Model.Subtotal.ToString("N0")ƒë</span>
                            @{
                                var productDiscount = Model.OriginalSubtotal - Model.Subtotal;
                            }
                            @if (productDiscount > 0)
                            {
                                <span class="original-subtotal">(ti·∫øt ki·ªám @productDiscount.ToString("N0")ƒë)</span>
                            }
                        </div>
                    </div>
                    
                    <div class="payment-row">
                        <span class="payment-label">Ph√≠ giao h√†ng</span>
                        <span class="payment-value">@Model.ShippingFee.ToString("N0")ƒë</span>
                    </div>
                    
                    @if (Model.Discount > 0)
                    {
                        <div class="payment-row">
                            <span class="payment-label">Voucher gi·∫£m gi√°</span>
                            <span class="payment-value payment-discount">- @Model.Discount.ToString("N0")ƒë</span>
                        </div>
                    }
                    
                    <div class="payment-row payment-total">
                        <span class="payment-label">Th√†nh ti·ªÅn</span>
                        <div class="payment-value-total">
                            <strong id="total">@Model.Total.ToString("N0")ƒë</strong>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- 5. H√åNH TH·ª®C THANH TO√ÅN -->
            <div class="checkout-section">
                <h2 class="section-title">H√¨nh th·ª©c thanh to√°n</h2>
                
                <label class="payment-option">
                    <input type="radio" name="PaymentMethod" value="COD" checked />
                    <div>
                        <div style="font-weight: 600;">Thanh to√°n khi nh·∫≠n h√†ng (COD)</div>
                        <div style="font-size: 13px; color: #6b7280;">Thanh to√°n b·∫±ng ti·ªÅn m·∫∑t khi nh·∫≠n h√†ng</div>
                    </div>
                </label>
                
                <label class="payment-option" id="banking-option">
                    <input type="radio" name="PaymentMethod" value="Banking" id="banking-radio" />
                    <div>
                        <div style="font-weight: 600;">Chuy·ªÉn kho·∫£n ng√¢n h√†ng</div>
                        <div style="font-size: 13px; color: #6b7280;">Chuy·ªÉn kho·∫£n qua Internet Banking</div>
                    </div>
                </label>
                
                <!-- Bank Selection (hidden by default) -->
                <div id="bank-selection" style="display: none; margin-left: 40px; margin-top: 8px;">
                    <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px;">
                        <!-- Vietcombank -->
                        <label class="ewallet-item">
                            <input type="radio" name="BankProvider" value="Vietcombank" class="ewallet-radio" />
                            <div class="ewallet-card">
                                <div class="ewallet-icon" style="background: white; padding: 4px;">
                                    <img src="~/images/payment-icons/vietcombank.png" alt="Vietcombank" style="width: 100%; height: 100%; object-fit: contain;" />
                                </div>
                                <span class="ewallet-name">VCB</span>
                            </div>
                        </label>
                        
                        <!-- VPBank -->
                        <label class="ewallet-item">
                            <input type="radio" name="BankProvider" value="VPBank" class="ewallet-radio" />
                            <div class="ewallet-card">
                                <div class="ewallet-icon" style="background: white; padding: 4px;">
                                    <img src="~/images/payment-icons/vpbank.png" alt="VPBank" style="width: 100%; height: 100%; object-fit: contain;" />
                                </div>
                                <span class="ewallet-name">VPB</span>
                            </div>
                        </label>
                    </div>
                </div>
                
                <label class="payment-option" id="ewallet-option">
                    <input type="radio" name="PaymentMethod" value="EWallet" id="ewallet-radio" />
                    <div>
                        <div style="font-weight: 600;">V√≠ ƒëi·ªán t·ª≠</div>
                        <div style="font-size: 13px; color: #6b7280;">MoMo, ZaloPay, VNPay, Apple Pay</div>
                    </div>
                </label>
                
                <!-- E-Wallet Selection (hidden by default) -->
                <div id="ewallet-selection" style="display: none; margin-left: 40px; margin-top: 8px;">
                    <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px;">
                        <!-- MoMo -->
                        <label class="ewallet-item">
                            <input type="radio" name="EWalletProvider" value="MoMo" class="ewallet-radio" />
                            <div class="ewallet-card">
                                <div class="ewallet-icon" style="background: white; padding: 4px;">
                                    <img src="~/images/payment-icons/momo.png" alt="MoMo" style="width: 100%; height: 100%; object-fit: contain;" />
                                </div>
                                <span class="ewallet-name">MoMo</span>
                            </div>
                        </label>
                        
                        <!-- ZaloPay -->
                        <label class="ewallet-item">
                            <input type="radio" name="EWalletProvider" value="ZaloPay" class="ewallet-radio" />
                            <div class="ewallet-card">
                                <div class="ewallet-icon" style="background: white; padding: 4px;">
                                    <img src="~/images/payment-icons/zalopay.png" alt="ZaloPay" style="width: 100%; height: 100%; object-fit: contain;" />
                                </div>
                                <span class="ewallet-name">ZaloPay</span>
                            </div>
                        </label>
                        
                        <!-- VNPay -->
                        <label class="ewallet-item">
                            <input type="radio" name="EWalletProvider" value="VNPay" class="ewallet-radio" />
                            <div class="ewallet-card">
                                <div class="ewallet-icon" style="background: white; padding: 4px;">
                                    <img src="~/images/payment-icons/vnpay.png" alt="VNPay" style="width: 100%; height: 100%; object-fit: contain;" />
                                </div>
                                <span class="ewallet-name">VNPay</span>
                            </div>
                        </label>
                        
                        <!-- Apple Pay -->
                        <label class="ewallet-item">
                            <input type="radio" name="EWalletProvider" value="ApplePay" class="ewallet-radio" />
                            <div class="ewallet-card">
                                <div class="ewallet-icon" style="background: white; padding: 4px;">
                                    <img src="~/images/payment-icons/applepay.png" alt="Apple Pay" style="width: 100%; height: 100%; object-fit: contain;" />
                                </div>
                                <span class="ewallet-name">Apple Pay</span>
                            </div>
                        </label>
                    </div>
                </div>
            </div>
            
            <!-- 6. ƒê·∫∂T H√ÄNG -->
            <div class="checkout-section">
                <button type="submit" class="btn-checkout">
                    ƒê·∫∂T H√ÄNG NGAY
                </button>
            </div>
        </form>
    }
    else
    {
        <div class="checkout-section" style="text-align: center; padding: 60px 20px;">
            <div style="font-size: 48px; margin-bottom: 16px;">üõí</div>
            <h3>Gi·ªè h√†ng tr·ªëng</h3>
            <p style="color: #6b7280; margin-bottom: 24px;">B·∫°n ch∆∞a c√≥ s·∫£n ph·∫©m n√†o trong gi·ªè h√†ng</p>
            <a href="@Url.Action("Index", "Home")" class="btn-checkout" style="display: inline-block; width: auto; padding: 12px 32px; text-decoration: none;">
                Ti·∫øp t·ª•c mua s·∫Øm
            </a>
        </div>
    }
</div>

<script>
    function toggleSelectAll(checkbox) {
        // Check if coupon is applied
        const hasCoupon = checkIfCouponApplied();
        
        if (hasCoupon) {
            // Remove coupon first, then reload
            removeAppliedCouponAndReload();
        } else {
            const itemCheckboxes = document.querySelectorAll('.cart-item-new .item-checkbox');
            itemCheckboxes.forEach(cb => cb.checked = checkbox.checked);
            recalculateCheckedTotals();
        }
    }
    
    function clearAll() {
        if (!confirm('B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a t·∫•t c·∫£ s·∫£n ph·∫©m?')) {
            return;
        }
        
        // Check if coupon is applied
        const hasCoupon = checkIfCouponApplied();
        
        if (hasCoupon) {
            // Remove coupon first, then clear all
            removeAppliedCouponThenClear();
        } else {
            window.location.href = '@Url.Action("Clear", "Cart")';
        }
    }
    
    async function removeAppliedCouponThenClear() {
        try {
            const response = await fetch('/Cart/RemoveCoupon', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                }
            });

            const result = await response.json();

            if (result.success) {
                showNotification('ƒê√£ h·ªßy m√£ gi·∫£m gi√°', 'info');
                // Wait a bit then clear all
                setTimeout(() => {
                    window.location.href = '@Url.Action("Clear", "Cart")';
                }, 500);
            } else {
                // If failed to remove coupon, still clear all
                window.location.href = '@Url.Action("Clear", "Cart")';
            }
        } catch (error) {
            console.error('Error removing coupon:', error);
            // If error, still clear all
            window.location.href = '@Url.Action("Clear", "Cart")';
        }
    }
    
    // Handle custom address input
    document.addEventListener('DOMContentLoaded', function() {
        const addressSelect = document.querySelector('select[name="ShippingAddress"]');
        const customAddressInput = document.getElementById('customAddress');
        
        if (addressSelect && customAddressInput) {
            addressSelect.addEventListener('change', function() {
                if (this.value === '') {
                    customAddressInput.style.display = 'block';
                    customAddressInput.name = 'ShippingAddress';
                    customAddressInput.required = true;
                    this.name = '';
                } else {
                    customAddressInput.style.display = 'none';
                    customAddressInput.name = '';
                    customAddressInput.required = false;
                    this.name = 'ShippingAddress';
                }
            });
        }
        
        // Handle coupon radio selection
        const couponRadios = document.querySelectorAll('.coupon-radio');
        const couponInput = document.getElementById('couponCodeInput');
        
        if (couponRadios && couponInput) {
            couponRadios.forEach(radio => {
                radio.addEventListener('change', function() {
                    if (this.checked) {
                        couponInput.value = this.value;
                    }
                });
            });
        }
        
        // Handle item checkbox changes to recalculate totals
        const itemCheckboxes = document.querySelectorAll('.cart-item-new .item-checkbox');
        itemCheckboxes.forEach(checkbox => {
            checkbox.addEventListener('change', handleCheckboxChange);
        });
        
        // Handle payment method selection to show/hide e-wallet options
        const paymentRadios = document.querySelectorAll('input[name="PaymentMethod"]');
        const ewalletSelection = document.getElementById('ewallet-selection');
        const bankSelection = document.getElementById('bank-selection');
        
        paymentRadios.forEach(radio => {
            radio.addEventListener('change', function() {
                // Hide both selections first
                ewalletSelection.style.display = 'none';
                bankSelection.style.display = 'none';
                
                // Show relevant selection
                if (this.value === 'EWallet' && this.checked) {
                    ewalletSelection.style.display = 'block';
                } else if (this.value === 'Banking' && this.checked) {
                    bankSelection.style.display = 'block';
                }
            });
        });
        
        // Initial calculation
        recalculateCheckedTotals();
    });
    
    function handleCheckboxChange() {
        // Check if coupon is applied
        const hasCoupon = checkIfCouponApplied();
        
        if (hasCoupon) {
            // Remove coupon first, then recalculate
            removeAppliedCouponAndReload();
        } else {
            recalculateCheckedTotals();
        }
    }
    
    function checkIfCouponApplied() {
        const paymentRows = document.querySelectorAll('.payment-row');
        for (const row of paymentRows) {
            const label = row.querySelector('.payment-label');
            if (label && label.textContent.includes('Voucher')) {
                return true;
            }
        }
        return false;
    }
    
    async function removeAppliedCouponAndReload() {
        try {
            const response = await fetch('/Cart/RemoveCoupon', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                }
            });

            const result = await response.json();

            if (result.success) {
                // Save form data before reload
                saveFormData();
                
                showNotification('ƒê√£ h·ªßy m√£ gi·∫£m gi√° do thay ƒë·ªïi gi·ªè h√†ng', 'info');
                // Reload page to update UI
                setTimeout(() => location.reload(), 1000);
            } else {
                recalculateCheckedTotals();
            }
        } catch (error) {
            console.error('Error removing coupon:', error);
            recalculateCheckedTotals();
        }
    }
    
    function recalculateCheckedTotals() {
        let checkedSubtotal = 0;
        let checkedOriginalSubtotal = 0;
        
        // Get all checked items
        const checkedItems = document.querySelectorAll('.cart-item-new .item-checkbox:checked');
        
        checkedItems.forEach(checkbox => {
            const itemElement = checkbox.closest('.cart-item-new');
            if (!itemElement) return;
            
            // Get current price
            const priceCurrentElement = itemElement.querySelector('.price-current');
            if (priceCurrentElement) {
                const priceText = priceCurrentElement.textContent.replace(/[^\d]/g, '');
                const price = parseInt(priceText) || 0;
                checkedSubtotal += price;
            }
            
            // Get original price if exists
            const priceOriginalElement = itemElement.querySelector('.price-original');
            if (priceOriginalElement) {
                const originalPriceText = priceOriginalElement.textContent.replace(/[^\d]/g, '');
                const originalPrice = parseInt(originalPriceText) || 0;
                checkedOriginalSubtotal += originalPrice;
            } else {
                // If no original price, use current price
                const priceText = priceCurrentElement?.textContent.replace(/[^\d]/g, '');
                const price = parseInt(priceText) || 0;
                checkedOriginalSubtotal += price;
            }
        });
        
        // Get shipping fee and discount
        let shippingFee = 30000; // Default
        let discount = 0;
        
        // Find shipping fee row
        const paymentRows = document.querySelectorAll('.payment-row');
        paymentRows.forEach(row => {
            const label = row.querySelector('.payment-label');
            if (label && label.textContent.includes('Ph√≠ giao h√†ng')) {
                const valueElement = row.querySelector('.payment-value');
                if (valueElement) {
                    const feeText = valueElement.textContent.replace(/[^\d]/g, '');
                    shippingFee = parseInt(feeText) || 30000;
                }
            }
            if (label && label.textContent.includes('Voucher')) {
                const valueElement = row.querySelector('.payment-value');
                if (valueElement) {
                    const discountText = valueElement.textContent.replace(/[^\d]/g, '');
                    discount = parseInt(discountText) || 0;
                }
            }
        });
        
        // Calculate total
        const total = checkedSubtotal + shippingFee - discount;
        
        // Update UI
        const subtotalElement = document.getElementById('subtotal');
        if (subtotalElement) {
            subtotalElement.textContent = formatCurrency(checkedSubtotal);
        }
        
        // Update product discount (ti·∫øt ki·ªám) under subtotal
        const productDiscount = checkedOriginalSubtotal - checkedSubtotal;
        const subtotalParent = subtotalElement?.parentElement;
        
        if (subtotalParent) {
            // Remove existing discount text
            const existingDiscount = subtotalParent.querySelector('.original-subtotal');
            if (existingDiscount) {
                existingDiscount.remove();
            }
            
            // Add new discount text if > 0
            if (productDiscount > 0) {
                const discountSpan = document.createElement('span');
                discountSpan.className = 'original-subtotal';
                discountSpan.textContent = `(ti·∫øt ki·ªám ${formatCurrency(productDiscount)})`;
                subtotalParent.appendChild(discountSpan);
            }
        }
        
        const totalElement = document.getElementById('total');
        if (totalElement) {
            totalElement.textContent = formatCurrency(total);
        }
    }
    
    function showCouponCondition(button) {
        const minAmount = parseFloat(button.getAttribute('data-min-amount'));
        const formatted = minAmount.toLocaleString('vi-VN');
        alert(`ƒêi·ªÅu ki·ªán: ƒê∆°n h√†ng t·ªëi thi·ªÉu ${formatted}ƒë`);
    }
</script>


